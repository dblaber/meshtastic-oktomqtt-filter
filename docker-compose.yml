version: '3.8'

services:
  mqtt-filter:
    build: .
    container_name: meshtastic-mqtt-filter
    restart: unless-stopped
    environment:
      # Override these in a .env file or docker-compose.override.yml
      - MQTT_BROKER=${MQTT_BROKER:-mqtt.patinhas.da4.org}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USERNAME:-meshdev}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-replaceme}
      - INPUT_TOPIC=${INPUT_TOPIC:-msh/US/NY/#}
      - OUTPUT_TOPIC=${OUTPUT_TOPIC:-filtered/msh/US/NY}
    volumes:
      # Mount directory for reject log (creates /logs in container)
      - ./logs:/logs
    command: >
      --broker ${MQTT_BROKER:-mqtt.patinhas.da4.org}
      --port ${MQTT_PORT:-1883}
      --username ${MQTT_USERNAME:-meshdev}
      --password ${MQTT_PASSWORD:-replaceme}
      --input-topic "${INPUT_TOPIC:-msh/US/NY/#}"
      --output-topic "${OUTPUT_TOPIC:-filtered/msh/US/NY}"
      --show-stats
      --reject-log /logs/rejected.log
      --allow-no-bitfield
    # For debugging, uncomment the following:
    # command: >
    #   --broker ${MQTT_BROKER:-mqtt.patinhas.da4.org}
    #   --port ${MQTT_PORT:-1883}
    #   --username ${MQTT_USERNAME:-meshdev}
    #   --password ${MQTT_PASSWORD:-replaceme}
    #   --input-topic "${INPUT_TOPIC:-msh/US/NY/#}"
    #   --output-topic "${OUTPUT_TOPIC:-filtered/msh/US/NY}"
    #   --show-stats
    #   --reject-log /logs/rejected.log
    #   --allow-no-bitfield
    #   --debug
